<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="ml-2 text-lg font-semibold text-gray-900">Dashboard</span>
                </div>
                <div id="userSection" class="hidden md:flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <img id="userPhoto" class="w-8 h-8 rounded-full" src="https://via.placeholder.com/32" alt="Profile">
                        <span id="userName" class="text-sm font-medium text-gray-700">User</span>
                    </div>
                    <button id="logoutBtn" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition duration-200">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-xl font-bold mb-4">Upload Data</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <label class="block text-sm font-medium text-gray-700">Enter Key:</label>
            <input id="dataKey" type="text" class="w-full p-2 border border-gray-300 rounded mt-1 mb-4" placeholder="Enter unique key">

            <label class="block text-sm font-medium text-gray-700">Enter Data:</label>
            <textarea id="dataValue" class="w-full p-2 border border-gray-300 rounded mt-1 mb-4" placeholder="Enter data"></textarea>

            <button id="uploadDataBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Upload Data
            </button>
        </div>

        <h2 class="text-xl font-bold mt-8 mb-4">Uploaded Data</h2>
        <div id="dataList" class="bg-white p-6 rounded-lg shadow-md space-y-2">
            <p>Loading...</p>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLW0P7Op6coJkNzJj0ck9pLNdneJplcbI",
            authDomain: "love-6996.firebaseapp.com",
            projectId: "love-6996",
            storageBucket: "love-6996.appspot.com",
            messagingSenderId: "1050433920317",
            appId: "1:1050433920317:web:99246747017f6bdca1b954",
            measurementId: "G-EKDTE6WQY1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/32';
                document.getElementById('userName').textContent = user.displayName || "User";
                document.getElementById('userSection').classList.remove('hidden');
                loadUserData(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => console.error("Sign-out error:", error));
        });

        document.getElementById('uploadDataBtn').addEventListener('click', async () => {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const dataKey = document.getElementById('dataKey').value.trim();
            const dataValue = document.getElementById('dataValue').value.trim();

            if (!dataKey || !dataValue) {
                alert("Please enter a key and data.");
                return;
            }

            db.collection("user_data").add({
                userId: user.uid,
                key: dataKey,
                value: dataValue,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Data uploaded successfully!");
                document.getElementById('dataKey').value = "";
                document.getElementById('dataValue').value = "";
                loadUserData(user.uid);
            }).catch(error => console.error("Error uploading data:", error));
        });

        function loadUserData(userId) {
    const dataList = document.getElementById('dataList');
    dataList.innerHTML = "<p>Loading...</p>";

    const userCollection = db.collection("user_data").where("userId", "==", userId);
    
    userCollection.get().then(snapshot => {
        if (snapshot.empty) {
            dataList.innerHTML = "<p>No data found.</p>";
            return;
        }

        // Check if timestamp field exists in at least one document
        let hasTimestamp = snapshot.docs.some(doc => doc.data().timestamp);

        // Fetch data with or without ordering
        let query = hasTimestamp ? userCollection.orderBy("timestamp", "desc") : userCollection;

        query.get().then(orderedSnapshot => {
            dataList.innerHTML = "";
            orderedSnapshot.forEach(doc => {
                const data = doc.data();
                const itemDiv = document.createElement("div");
                itemDiv.className = "p-4 border border-gray-300 rounded";

                itemDiv.innerHTML = `
                    <p><strong>Key:</strong> ${data.key}</p>
                    <p><strong>Data:</strong> ${data.value}</p>
                `;
                dataList.appendChild(itemDiv);
            });
        }).catch(error => {
            console.error("Error loading data:", error);
            dataList.innerHTML = "<p>Error loading data.</p>";
        });

    }).catch(error => {
        console.error("Error fetching data:", error);
        dataList.innerHTML = "<p>Error loading data.</p>";
    });
        }
    </script>
</body>
</html>
